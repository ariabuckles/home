include <tunables/global>

# To install global things, run unconfined node16 instead
profile aria-dev /usr/bin/{node,npm,npx,node-default,yarn} {
  include <abstractions/base>
  include <abstractions/consoles>

  deny capability setuid,

  # Other executables
  /bin/** mrix,
  /usr/bin/** mrix,
  /usr/lib*/** mrix,
  /usr/include/node** mrix,
  /usr/**/node_modules** mrwix,
  /tmp/** mrwix, # yarn executes node scripts in here
  owner @{HOME}/.pyenv/** mrix,

  # TODO: limit these more?
  /usr/share/** r,
  owner @{HOME}/.local/share/** r,
  owner @{HOME}/.cache/** r,
  /sys/fs/cgroup/memory/memory.limit_in_bytes r,
  /usr/** r,
  /etc/** r,
  /run/** r,
  /var/** r,
  /sys/** r,
  /proc/** r, # yarn needs this for reeding memory

  network,

  # TODO: limit this to only npm:
  owner @{HOME}/.npm/** rw,
  owner @{HOME}/bin/* mrix,
  owner @{HOME}/lib/node_modules** r,
  owner @{HOME}/.npmrc r,
  owner @{HOME}/home/.npmrc r,

  # yarn
  owner @{HOME}/.cache/yarn/** rw,
  owner @{HOME}/.yarnrc rw,
  owner @{HOME}/home/.yarnrc rw,

  # vercel
  owner @{HOME}/.local/share/com.vercel.cli** rw,
  owner @{HOME}/.cache/com.vercel.cli** rw,

  # Allow access to some config files
  owner @{HOME}/.gitconfig r,
  owner @{HOME}/.gitignoreglobal r,
  owner @{HOME}/.gitignore r,
  owner @{HOME}/home/.gitconfig r,
  owner @{HOME}/home/.gitignoreglobal r,
  owner @{HOME}/home/.gitignore r,
  owner @{HOME}/.local/.node_repl_history rw,
  owner @{HOME}/.config/mimeapps.list r,
  owner @{HOME}/.config/configstore/nodemon.** rw,

  # TODO: limit these to viridium only:
  owner @{HOME}/.viridium.json rw,
  owner @{HOME}/home/.viridium.json rw,

  # Allow access to dev directories:
  owner @{HOME}/{src,.src,code}/** mrwix,
  owner /mnt/ramdisk/src/** mrwix,
}
